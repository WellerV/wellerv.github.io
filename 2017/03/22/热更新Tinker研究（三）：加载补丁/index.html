<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Android,补丁,热更新,源码分析," />










<meta name="description" content="本系列文章主要通过源码来分析热修复框架tinker的原理。">
<meta name="keywords" content="Android,补丁,热更新,源码分析">
<meta property="og:type" content="article">
<meta property="og:title" content="热更新Tinker研究（三）：加载补丁">
<meta property="og:url" content="http://yoursite.com/2017/03/22/热更新Tinker研究（三）：加载补丁/index.html">
<meta property="og:site_name" content="WellerV‘s blog">
<meta property="og:description" content="本系列文章主要通过源码来分析热修复框架tinker的原理。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://on8vjlgub.bkt.clouddn.com/tinker_id.png">
<meta property="og:image" content="http://on8vjlgub.bkt.clouddn.com/meta_tinker_id.png">
<meta property="og:updated_time" content="2017-12-11T11:31:29.021Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="热更新Tinker研究（三）：加载补丁">
<meta name="twitter:description" content="本系列文章主要通过源码来分析热修复框架tinker的原理。">
<meta name="twitter:image" content="http://on8vjlgub.bkt.clouddn.com/tinker_id.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/03/22/热更新Tinker研究（三）：加载补丁/"/>





  <title>热更新Tinker研究（三）：加载补丁 | WellerV‘s blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WellerV‘s blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/22/热更新Tinker研究（三）：加载补丁/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="WellerV">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://on8vjlgub.bkt.clouddn.com/9s.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WellerV‘s blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">热更新Tinker研究（三）：加载补丁</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-22T17:41:00+08:00">
                2017-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/基于源码的热更新Tinker框架研究/" itemprop="url" rel="index">
                    <span itemprop="name">基于源码的热更新Tinker框架研究</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本系列文章主要通过源码来分析热修复框架tinker的原理。<br><a id="more"></a></p>
<p>本文主要讲解Tinker加载patch.apk的过程，主要是研究当把patch_signed_7zip.apk推送到sdcard之后，点击LOAD  PATCH按钮之后的流程分析。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loadPatchButton.setOnClickListener(new View.OnClickListener() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void onClick(View v) &#123;</span><br><span class="line">        TinkerInstaller.onReceiveUpgradePatch(getApplicationContext(), Environment.getExternalStorageDirectory().getAbsolutePath() + &quot;/patch_signed_7zip.apk&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>patch的整个过程如下所示：</p>
<p><div id="flowchart-0" class="flow-chart"></div><br>除了NEW_TINKER_ID和TINKER_ID,其他的字段主要对应build.gradle中的属性packageConfig自定义的字段值<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">packageConfig &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * optional，default 'TINKER_ID, TINKER_ID_VALUE' 'NEW_TINKER_ID, NEW_TINKER_ID_VALUE'</span></span><br><span class="line"><span class="comment">     * package meta file gen. path is assets/package_meta.txt in patch file</span></span><br><span class="line"><span class="comment">     * you can use securityCheck.getPackageProperties() in your ownPackageCheck method</span></span><br><span class="line"><span class="comment">     * or TinkerLoadResult.getPackageConfigByName</span></span><br><span class="line"><span class="comment">     * we will get the TINKER_ID from the old apk manifest for you automatic,</span></span><br><span class="line"><span class="comment">     * other config files (such as patchMessage below)is not necessary</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    configField(<span class="string">"patchMessage"</span>, <span class="string">"tinker is sample to use"</span>)</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * just a sample case, you can use such as sdkVersion, brand, channel...</span></span><br><span class="line"><span class="comment">     * you can parse it in the SamplePatchListener.</span></span><br><span class="line"><span class="comment">     * Then you can use patch conditional!</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    configField(<span class="string">"platform"</span>, <span class="string">"all"</span>)</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * patch version via packageConfig</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    configField(<span class="string">"patchVersion"</span>, <span class="string">"1.0"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>自定义一些变量，用于在版本之间传递，可以更多地自己去控制流程，方便信息的扩展。</p>
<h3 id="3，dex-meta-txt"><a href="#3，dex-meta-txt" class="headerlink" title="3，dex_meta.txt"></a>3，dex_meta.txt</h3><p>下面是一个dex_meta.txt的实例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">classes.dex,,7e197a86bfc55b2345e49254670d13ad,7e197a86bfc55b2345e49254670d13ad,212f0b11b6ff37a4153c8bb6e572d3ef,1880959952,jar</span><br><span class="line">test.dex,,56900442eb5b7e1de45449d0685e6e00,56900442eb5b7e1de45449d0685e6e00,0,0,jar</span><br></pre></td></tr></table></figure></p>
<p>用表格描述<br>| name  | path | destMd5InDvm | destMd5InArt | dexDiffMd5 | oldDexCrc | dexMode |<br>| ——-  | —– | ——————  | —————– | ————— | ————- | ————|<br>|classes.dex||7e197a86bfc55b2345e49254670d13ad|7e197a86bfc55b2345e49254670d13ad|212f0b11b6ff37a4153c8bb6e572d3ef|1880959952|jar|<br>|test.dex||56900442eb5b7e1de45449d0685e6e00|56900442eb5b7e1de45449d0685e6e00|0|0|jar|<br>destMd5InDvm和destMd5InArt分别对应不同虚拟机下生成的dex文件的md5，因为需要合成的dex文件的md5其实已经知道了，所以这里主要用于校验。dexDiffMd5是当前补丁dex对应的md5。dexMode是指dex文件的压缩模式，有jar和dex两种。</p>
<h3 id="4，res-meta-txt"><a href="#4，res-meta-txt" class="headerlink" title="4，res_meta.txt"></a>4，res_meta.txt</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">resources_out.zip,1310764963,7d766f7aeead0c72a6479d55d255c611</span><br><span class="line">pattern:3</span><br><span class="line">resources.arsc</span><br><span class="line">res/*</span><br><span class="line">assets/*</span><br><span class="line">modify:2</span><br><span class="line">res/layout/activity_main.xml</span><br><span class="line">res/layout-v17/activity_main.xml</span><br><span class="line">add:1</span><br><span class="line">assets/only_use_to_test_tinker_resource.txt</span><br></pre></td></tr></table></figure>
<p>包含生成资源包文件，md5，以及过滤目录，修改增加信息等等。</p>
<h2 id="二、日志分析jieguo"><a href="#二、日志分析jieguo" class="headerlink" title="二、日志分析jieguo"></a>二、日志分析jieguo</h2><p>下面的日志截取真实环境，并做了一些删减，结合日志，能够更方便地帮我们分析整个load patch的过程。下面的日志为方便阅读源码使用，不必深究。</p>
<h3 id="接收Patch-File"><a href="#接收Patch-File" class="headerlink" title="接收Patch File"></a>接收Patch File</h3><p>TinkerInstaller接收到patch file,并启动TinkerPatchService。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">03-16 14:41:57.362 8508-8508/tinker.sample.android I/Tinker.SamplePatchListener: receive a patch file: /storage/emulated/0/patch_signed_7zip.apk, file size:7322</span><br><span class="line">03-16 14:41:57.401 8508-8508/tinker.sample.android W/Tinker.UpgradePatchRetry: onPatchListenerCheck retry file is not exist, just return</span><br><span class="line">03-16 14:41:57.408 8508-8508/tinker.sample.android I/Tinker.SamplePatchListener: get platform:all</span><br><span class="line">03-16 14:41:57.412 1169-1426/system_process V/ActivityManager: startService: Intent &#123; cmp=tinker.sample.android/com.tencent.tinker.lib.service.TinkerPatchService (has extras) &#125; callerApp=ProcessRecord&#123;f11eaa9 8508:tinker.sample.android/u0a172&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="应用目录加载patch"><a href="#应用目录加载patch" class="headerlink" title="应用目录加载patch"></a>应用目录加载patch</h3><p>从应用程序目录检查patchInfo,并进行补丁加载<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">03-16 14:41:57.777 8958-8958/tinker.sample.android:patch W/Tinker.TinkerLoader: tryLoadPatchFiles:patch dir not exist:/data/user/0/tinker.sample.android/tinker</span><br><span class="line">03-16 14:41:57.782 8958-8958/tinker.sample.android:patch D/Tinker.DefaultAppLike: onBaseContextAttached:</span><br><span class="line">03-16 14:41:57.808 8958-8958/tinker.sample.android:patch I/Tinker.SamplePatchListener: application maxMemory:256</span><br><span class="line">03-16 14:41:57.817 8958-8958/tinker.sample.android:patch W/Tinker.Tinker: tinker patch directory: /data/user/0/tinker.sample.android/tinker</span><br><span class="line">03-16 14:41:57.823 8958-8958/tinker.sample.android:patch I/Tinker.Tinker: try to install tinker, isEnable: true, version: 1.7.7</span><br><span class="line">03-16 14:41:57.826 8958-8958/tinker.sample.android:patch I/Tinker.TinkerLoadResult: parseTinkerResult loadCode:-2, systemOTA:false</span><br><span class="line">03-16 14:41:57.827 8958-8958/tinker.sample.android:patch W/Tinker.TinkerLoadResult: can&apos;t find patch file, is ok, just return</span><br><span class="line">03-16 14:41:57.828 8958-8958/tinker.sample.android:patch I/Tinker.DefaultLoadReporter: patch loadReporter onLoadResult: patch load result, path:/data/user/0/tinker.sample.android/tinker, code:-2, cost:6</span><br><span class="line">03-16 14:41:57.829 8958-8958/tinker.sample.android:patch W/Tinker.Tinker: tinker load fail!</span><br><span class="line">03-16 14:41:57.832 8958-8958/tinker.sample.android:pa缺少tch D/Tinker.DefaultAppLike: onCreate</span><br></pre></td></tr></table></figure></p>
<h3 id="tryPatch"><a href="#tryPatch" class="headerlink" title="tryPatch"></a>tryPatch</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">03-16 14:41:58.102 8958-8980/tinker.sample.android:patch I/Tinker.UpgradePatch:     public void onPatchRetryLoad() &#123;</span><br><span class="line">        if (!isRetryEnable) &#123;</span><br><span class="line">            TinkerLog.w(TAG, &quot;onPatchRetryLoad retry disabled, just return&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        Tinker tinker = Tinker.with(context);</span><br><span class="line">        //only retry on main process</span><br><span class="line">        if (!tinker.isMainProcess()) &#123;</span><br><span class="line">            TinkerLog.w(TAG, &quot;onPatchRetryLoad retry is not main process, just return&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!retryInfoFile.exists()) &#123;</span><br><span class="line">            TinkerLog.w(TAG, &quot;onPatchRetryLoad retry info not exist, just return&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (TinkerServiceInternals.isTinkerPatchServiceRunning(context)) &#123;</span><br><span class="line">            TinkerLog.w(TAG, &quot;onPatchRetryLoad tinker ser缺少vice is running, just return&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //must use temp file</span><br><span class="line">        String path = tempPatchFile.getAbsolutePath();</span><br><span class="line">        if (path == null || !new File(path).exists()) &#123;</span><br><span class="line">            TinkerLog.w(TAG, &quot;onPatchRetryLoad patch file: %s is not exist, just return&quot;, path);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        TinkerLog.w(TAG, &quot;onPatchRetryLoad patch file: %s is exist, retry to patch&quot;, path);</span><br><span class="line">        TinkerInstaller.onReceiveUpgradePatch(context, path);</span><br><span class="line">        SampleTinkerReport.onReportRetryPatch();</span><br><span class="line">    &#125; tryPatch:patchMd5:9b4fece1c1516b04bdbe7c90b7832910</span><br><span class="line">03-16 14:41:58.102 8958-8980/tinker.sample.android:patch I/Tinker.UpgradePatch: UpgradePatch tryPatch:patchVersionDirectory:/data/user/0/tinker.sample.android/tinker/patch-9b4fece1</span><br><span class="line">03-16 14:41:58.109 8958-8980/tinker.sample.android:patch W/Tinker.UpgradePatch: UpgradePatch copy patch file, src file: /storage/emulated/0/patch_signed_7zip.apk size: 7322, dest file: /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/patch-9b4fece1.apk size:7322</span><br><span class="line">03-16 14:42:00.789 8958-8980/tinker.sample.android:patch W/Tinker.DexDiffPatchInternal: success recover dex file: /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/dex/classes.dex.jar, size: 849611, use time: 2642</span><br><span class="line">03-16 14:42:00.791 8958-8980/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: try Extracting /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/dex/test.dex.jar</span><br><span class="line">03-16 14:42:00.795 8958-8980/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: isExtractionSuccessful: true</span><br><span class="line">03-16 14:42:00.797 8958-8980/tinker.sample.android:patch W/Tinker.DexDiffPatchInternal: patch recover, try to optimize dex file count:2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">03-16 14:42:00.804 8958-9022/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: start to parallel optimize dex /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/dex/classes.dex.jar, size: 849611</span><br><span class="line">03-16 14:42:00.804 8958-9023/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: start to parallel optimize dex /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/dex/test.dex.jar, size: 470</span><br><span class="line">                                                                                        </span><br><span class="line">                                                                                        [ 03-16 14:42:00.849  1169: 1214 E/         ]</span><br><span class="line">                                                                                        CWM:[999]readEvents:In</span><br><span class="line">                                                                                        </span><br><span class="line">                                                                                        </span><br><span class="line">                                                                                        [ 03-16 14:42:00.849  1169: 1214 E/         ]</span><br><span class="line">                                                                                        CWM:[1446]processEvent:Id=0,data:0.05:0.02:9.73</span><br><span class="line">                                                                                        </span><br><span class="line">                                                                                        </span><br><span class="line">                                                                                        [ 03-16 14:42:00.849  1169: 1214 E/         ]</span><br><span class="line">                                                                                        CWM:[1059]readEvents:Out:numEventReceived[1]</span><br><span class="line">03-16 14:42:00.947 8958-9023/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: success to parallel optimize dex /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/dex/test.dex.jar, opt file size: 8872, use time 143</span><br><span class="line">03-16 14:42:01.311 8958-9022/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: success to parallel optimize dex /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/dex/classes.dex.jar, opt file size: 2093736, use time 507</span><br><span class="line">03-16 14:42:01.312 8958-8980/tinker.sample.android:patch I/Tinker.ParallelDex: All dexes are optimized successfully, cost: 512 ms.</span><br><span class="line">03-16 14:42:01.314 8958-8980/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: recover dex result:true, cost:3195</span><br><span class="line">03-16 14:42:01.319 8958-8980/tinker.sample.android:patch W/Tinker.BsDiffPatchInternal: patch recover, library is not contained</span><br><span class="line">                                                                                       </span><br><span class="line">                                                                                       [ 03-16 14:42:01.326  1169: 1214 E/         ]</span><br><span class="line">                                                                                       CWM:[999]readEvents:In</span><br><span class="line">                                                                                       </span><br><span class="line">                                                                                       </span><br><span class="line">                                                                                       [ 03-16 14:42:01.326  1169: 1214 E/         ]</span><br><span class="line">                                                                                       CWM:[1446]processEvent:Id=0,data:0.05:0.01:9.74</span><br><span class="line">                                                                                       </span><br><span class="line">                                                                                       </span><br><span class="line">                                                                                       [ 03-16 14:42:01.326  1169: 1214 E/         ]</span><br><span class="line">                                                                                   [缺少类关系图]    CWM:[1059]readEvents:Out:numEventReceived[1]</span><br><span class="line">03-16 14:42:01.328 8958-8980/tinker.sample.android:patch I/Tinker.ResDiffPatchInternal: res dir: /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/res/, meta: resArscMd5:7d766f7aeead0c72a6479d55d255c611</span><br><span class="line">                                                                                        arscBaseCrc:1310764963</span><br><span class="line">                                                                                        pattern:res/.*</span><br><span class="line">                                                                                        pattern:assets/.*</span><br><span class="line">                                                                                        pattern:resources\.arsc</span><br><span class="line">                                                                                        addedSet:assets/only_use_to_test_tinker_resource.txt</span><br><span class="line">                                                                                        modifiedSet:res/layout/activity_main.xml</span><br><span class="line">                                                                                        modifiedSet:res/layout-v17/activity_main.xml</span><br><span class="line">03-16 14:42:01.346 8958-8980/tinker.sample.android:patch I/Tinker.ResDiffPatchInternal: no large modify resources, just return</span><br><span class="line">03-16 14:42:01.357 8958-8980/tinker.sample.android:patch W/art: Method processed more than once: void com.tencent.tinker.commons.ziputil.TinkerZipEntry.&lt;init&gt;(byte[], java.io.InputStream, java.nio.charset.Charset, boolean)</span><br><span class="line">03-16 14:42:01.575 8958-8980/tinker.sample.android:patch I/Tinker.ResDiffPatchInternal: final new resource file:/data/user/0/tinker.sample.android/tinker/patch-9b4fece1/res/resources.apk, entry count:327, size:438132</span><br><span class="line">03-16 14:42:01.575 8958-8980/tinker.sample.android:patch I/Tinker.ResDiffPatchInternal: recover resource result:true, cost:251</span><br><span class="line">03-16 14:42:01.576 8958-8980/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: dex count: 2, final wait time: 1203-16 14:41:58.102 8958-8980/tinker.sample.android:patch I/Tinker.UpgradePatch: UpgradePatch tryPatch:patchMd5:9b4fece1c1516b04bdbe7c90b7832910</span><br><span class="line">03-16 14:41:58.102 8958-8980/tinker.sample.android:patch I/Tinker.UpgradePatch: UpgradePatch tryPatch:patchVersionDirectory:/data/user/0/tinker.sample.android/tinker/patch-9b4fece1</span><br><span class="line">03-16 14:41:58.109 8958-8980/tinker.sample.android:patch W/Tinker.UpgradePatch: UpgradePatch copy patch file, src file: /storage/emulated/0/patch_signed_7zip.apk size: 7322, dest file: /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/patch-9b4fece1.apk size:7322</span><br><span class="line">03-16 14:42:00.789 8958-8980/tinker.sample.android:patch W/Tinker.DexDiffPatchInternal: success recover dex file: /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/dex/classes.dex.jar, size: 849611, use time: 2642</span><br><span class="line">03-16 14:42:00.791 8958-8980/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: try Extracting /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/dex/test.dex.jar</span><br><span class="line">03-16 14:42:00.795 8958-8980/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: isExtractionSuccessful: true</span><br><span class="line">03-16 14:42:00.797 8958-8980/tinker.sample.android:patch W/Tinker.DexDiffPatchInternal: patch recover, try to optimize dex file count:2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">03-16 14:42:00.804 8958-9022/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: start to parallel optimize dex /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/dex/classes.dex.jar, size: 849611</span><br><span class="line">03-16 14:42:00.804 8958-9023/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: start to parallel optimize dex /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/dex/test.dex.jar, size: 470</span><br><span class="line">                                                                                        </span><br><span class="line">                                                                                        [ 03-16 14:42:00.849  1169: 1214 E/         ]</span><br><span class="line">                                                                                        CWM:[999]readEvents:In</span><br><span class="line">                                                                                        </span><br><span class="line">                                                                                        </span><br><span class="line">                                                                                        [ 03-16 14:42:00.849  1169: 1214 E/         ]</span><br><span class="line">                                                                                        CWM:[1446]processEvent:Id=0,data:0.05:0.02:9.73</span><br><span class="line">                                                                                        </span><br><span class="line">                                                                                        </span><br><span class="line">                                                                                        [ 03-16 14:42:00.849  1169: 1214 E/         ]</span><br><span class="line">                                                                                        CWM:[1059]readEvents:Out:numEventReceived[1]</span><br><span class="line">03-16 14:42:00.947 8958-9023/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: success to parallel optimize dex /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/dex/test.dex.jar, opt file size: 8872, use time 143</span><br><span class="line">03-16 14:42:01.311 8958-9022/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: success to parallel optimize dex /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/dex/classes.dex.jar, opt file size: 2093736, use time 507</span><br><span class="line">03-16 14:42:01.312 8958-8980/tinker.sample.android:patch I/Tinker.ParallelDex: All dexes are optimized successfully, cost: 512 ms.</span><br><span class="line">03-16 14:42:01.314 8958-8980/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: recover dex result:true, cost:3195</span><br><span class="line">03-16 14:42:01.319 8958-8980/tinker.sample.android:patch W/Tinker.BsDiffPatchInternal: patch recover, library is not contained</span><br><span class="line">                                                                                       </span><br><span class="line">                                                                                       [ 03-16 14:42:01.326  1169: 1214 E/         ]</span><br><span class="line">                                                                                       CWM:[999]readEvents:In</span><br><span class="line">                                                                                       </span><br><span class="line">                                                                                       </span><br><span class="line">                                                                                       [ 03-16 14:42:01.326  1169: 1214 E/         ]</span><br><span class="line">                                                                                       CWM:[1446]processEvent:Id=0,data:0.05:0.01:9.74</span><br><span class="line">                                                                                       </span><br><span class="line">                                                                                       </span><br><span class="line">                                                                                       [ 03-16 14:42:01.326  1169: 1214 E/         ]</span><br><span class="line">                                                                                       CWM:[1059]readEvents:Out:numEventReceived[1]</span><br><span class="line">03-16 14:42:01.328 8958-8980/tinker.sample.android:patch I/Tinker.ResDiffPatchInternal: res dir: /data/user/0/tinker.sample.android/tinker/patch-9b4fece1/res/, meta: resArscMd5:7d766f7aeead0c72a6479d55d255c611</span><br><span class="line">                                                                                        arscBaseCrc:1310764963</span><br><span class="line">                                                                                        pattern:res/.*</span><br><span class="line">                                                                                        pattern:assets/.*</span><br><span class="line">                                                                                        pattern:resources\.arsc</span><br><span class="line">                                                                                        addedSet:assets/only_use_to_test_tinker_resource.txt</span><br><span class="line">                                                                                        modifiedSet:res/layout/activity_main.xml</span><br><span class="line">                                                                                        modifiedSet:res/layout-v17/activity_main.xml</span><br><span class="line">03-16 14:42:01.346 8958-8980/tinker.sample.android:patch I/Tinker.ResDiffPatchInternal: no large modify resources, just return</span><br><span class="line">03-16 14:42:01.357 8958-8980/tinker.sample.android:patch W/art: Method processed more than once: void com.tencent.tinker.commons.ziputil.TinkerZipEntry.&lt;init&gt;(byte[], java.io.InputStream, java.nio.charset.Charset, boolean)</span><br><span class="line">03-16 14:42:01.575 8958-8980/tinker.sample.android:patch I/Tinker.ResDiffPatchInternal: final new resource file:/data/user/0/tinker.sample.android/tinker/patch-9b4fece1/res/resources.apk, entry count:327, size:438132</span><br><span class="line">03-16 14:42:01.575 8958-8980/tinker.sample.android:patch I/Tinker.ResDiffPatchInternal: recover resource result:true, cost:251</span><br><span class="line">03-16 14:42:01.576 8958-8980/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: dex count: 2, final wait time: 12</span><br></pre></td></tr></table></figure>
<h3 id="检查odex文件"><a href="#检查odex文件" class="headerlink" title="检查odex文件"></a>检查odex文件</h3><p>负责等待DexOpt优化完dex，并对odex文件进行校验。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">03-16 14:42:01.576 8958-8980/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: dex count: 2, final wait time: 12</span><br><span class="line">03-16 14:42:01.581 8958-8980/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: check dex optimizer file classes.dex.dex, size 2093736</span><br><span class="line">03-16 14:42:01.582 8958-8980/tinker.sample.android:patch I/Tinker.DexDiffPatchInternal: check dex optimizer file test.dex.dex, size 8872</span><br><span class="line">03-16 14:42:01.591 8958-8980/tinker.sample.android:patch W/Tinker.UpgradePatch: UpgradePatch tryPatch: done, it is ok</span><br></pre></td></tr></table></figure></p>
<h3 id="处理Result"><a href="#处理Result" class="headerlink" title="处理Result"></a>处理Result</h3><p>针对patch返回的结果进行一些相应的操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">03-16 14:42:01.592 8958-8980/tinker.sample.android:patch I/Tinker.PatchFileUtil: safeDeleteFile, try to delete path: /data/user/0/tinker.sample.android/tinker_temp/temp.apk</span><br><span class="line">03-16 14:42:01.680 8508-9051/tinker.sample.android I/Tinker.SampleResultService: SampleResultService receive result: </span><br><span class="line">                                                                                 PatchResult: </span><br><span class="line">                                                                                 isSuccess:true</span><br><span class="line">                                                                                 rawPatchFilePath:/storage/emulated/0/patch_signed_7zip.apk</span><br><span class="line">                                                                                 costTime:3638</span><br><span class="line">                                                                                 patchVersion:9b4fece1c1516b04bdbe7c90b7832910</span><br><span class="line">03-16 14:42:01.704 8508-9051/tinker.sample.android W/Tinker.DefaultTinkerResultService: deleteRawPatchFile rawFile path: /storage/emulated/0/patch_signed_7zip.apk</span><br><span class="line">03-16 14:42:01.704 8508-9051/tinker.sample.android I/Tinker.PatchFileUtil: safeDeleteFile, try to delete path: /storage/emulated/0/patch_signed_7zip.apk</span><br><span class="line">03-16 14:42:01.706 8508-9051/tinker.sample.android I/Tinker.SampleResultService: tinker wait screen to restart process</span><br></pre></td></tr></table></figure></p>
<h2 id="三、接收PatchFile"><a href="#三、接收PatchFile" class="headerlink" title="三、接收PatchFile"></a>三、接收PatchFile</h2><p>TinkerInstaller的onReceiveUpgradePatch()最终会调用SamplePatchListener的onPatchReceived（）方法。</p>
<h3 id="patchCheck"><a href="#patchCheck" class="headerlink" title="patchCheck"></a>patchCheck</h3><p>主要是进行patch listener状态的检测，包含tinker开关、文件是否合法、进程状态、Service状态、平台属性的检测。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">patchCheck</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    Tinker manager = Tinker.with(context);</span><br><span class="line">    <span class="comment">//check SharePreferences also</span></span><br><span class="line">    <span class="keyword">if</span> (!manager.isTinkerEnabled() || !ShareTinkerInternals.isTinkerEnableWithSharedPreferences(context)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ShareConstants.ERROR_PATCH_DISABLE;</span><br><span class="line">    &#125;</span><br><span class="line">    File file = <span class="keyword">new</span> File(path);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!SharePatchFileUtil.isLegalFile(file)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ShareConstants.ERROR_PATCH_NOTEXIST;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//patch service can not send request</span></span><br><span class="line">    <span class="keyword">if</span> (manager.isPatchProcess()) &#123;</span><br><span class="line">        <span class="keyword">return</span> ShareConstants.ERROR_PATCH_INSERVICE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//if the patch service is running, pending</span></span><br><span class="line">    <span class="keyword">if</span> (TinkerServiceInternals.isTinkerPatchServiceRunning(context)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ShareConstants.ERROR_PATCH_RUNNING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ShareConstants.ERROR_PATCH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="启动TinkerPatchService"><a href="#启动TinkerPatchService" class="headerlink" title="启动TinkerPatchService"></a>启动TinkerPatchService</h3><p>TinkerPatchService运行在单独的进程xxx:process里面,由于是IntentService,也是在单独的线程里面运行，并且会启动后一个InnerSerivce来提高优先级。</p>
<p>真正执行patch的对象是upgradePatchProcessor，由resultServiceClass来接收结果。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TinkerPatchService</span> <span class="keyword">extends</span> <span class="title">IntentService</span> </span>&#123;</span><br><span class="line">	 ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span>       AbstractPatch upgradePatchProcessor = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span>       Class&lt;? extends AbstractResultService&gt; resultServiceClass   = <span class="keyword">null</span>;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>然后为了提高Service的优先级，除了startForeground（），还会启动一个InnerService。</p>
<h2 id="四、应用目录加载patch"><a href="#四、应用目录加载patch" class="headerlink" title="四、应用目录加载patch"></a>四、应用目录加载patch</h2><p>application的onBaseAttach()每次在context重新创建时会调用，主要是去应用目录下加载patch.apk，核心代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPatchRetryLoad</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//isRetryEnable开关</span></span><br><span class="line">    <span class="keyword">if</span> (!isRetryEnable) &#123;</span><br><span class="line">        TinkerLog.w(TAG, <span class="string">"onPatchRetryLoad retry disabled, just return"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Tinker tinker = Tinker.with(context);</span><br><span class="line">    <span class="comment">//only retry on main process</span></span><br><span class="line">    <span class="keyword">if</span> (!tinker.isMainProcess()) &#123;</span><br><span class="line">        TinkerLog.w(TAG, <span class="string">"onPatchRetryLoad retry is not main process, just return"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!retryInfoFile.exists()) &#123;</span><br><span class="line">        TinkerLog.w(TAG, <span class="string">"onPatchRetryLoad retry info not exist, just return"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TinkerServiceInternals.isTinkerPatchServiceRunning(context)) &#123;</span><br><span class="line">        TinkerLog.w(TAG, <span class="string">"onPatchRetryLoad tinker service is running, just return"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//去取temp.apk</span></span><br><span class="line">    String path = tempPatchFile.getAbsolutePath();</span><br><span class="line">    <span class="keyword">if</span> (path == <span class="keyword">null</span> || !<span class="keyword">new</span> File(path).exists()) &#123;</span><br><span class="line">        TinkerLog.w(TAG, <span class="string">"onPatchRetryLoad patch file: %s is not exist, just return"</span>, path);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    TinkerLog.w(TAG, <span class="string">"onPatchRetryLoad patch file: %s is exist, retry to patch"</span>, path);</span><br><span class="line">    <span class="comment">//检查temp路径下的patch文件情况</span></span><br><span class="line">    TinkerInstaller.onReceiveUpgradePatch(context, path);</span><br><span class="line">    SampleTinkerReport.onReportRetryPatch();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="五、tryPatch"><a href="#五、tryPatch" class="headerlink" title="五、tryPatch"></a>五、tryPatch</h2><h3 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h3><h4 id="文件合法性校验"><a href="#文件合法性校验" class="headerlink" title="文件合法性校验"></a>文件合法性校验</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!SharePatchFileUtil.isLegalFile(patchFile)) &#123;</span><br><span class="line">    TinkerLog.e(TAG, <span class="string">"UpgradePatch tryPatch:patch file is not found, just return"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="signature校验"><a href="#signature校验" class="headerlink" title="signature校验"></a>signature校验</h4><p>首先通过包管理器获取publicKey<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PackageManager pm = context.getPackageManager();</span><br><span class="line">String packageName = context.getPackageName();</span><br><span class="line">PackageInfo packageInfo = pm.getPackageInfo(packageName, PackageManager.GET_SIGNATURES);</span><br><span class="line">CertificateFactory certFactory = CertificateFactory.getInstance(<span class="string">"X.509"</span>);</span><br><span class="line">stream = <span class="keyword">new</span> ByteArrayInputStream(packageInfo.signatures[<span class="number">0</span>].toByteArray());</span><br><span class="line">X509Certificate cert = (X509Certificate) certFactory.generateCertificate(stream);</span><br><span class="line">mPublicKey = cert.getPublicKey();</span><br></pre></td></tr></table></figure></p>
<p>然后去校验apk中文件的签名，为了加快效率，这里只检查meta.txt结尾的几个文件。主要是dex_meta.txt，res_mete.txt等等。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verifyPatchMetaSignature</span><span class="params">(File path)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (!SharePatchFileUtil.isLegalFile(path)) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       JarFile jarFile = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           jarFile = <span class="keyword">new</span> JarFile(path);</span><br><span class="line">           <span class="keyword">final</span> Enumeration&lt;JarEntry&gt; entries = jarFile.entries();</span><br><span class="line">           <span class="keyword">while</span> (entries.hasMoreElements()) &#123;</span><br><span class="line">               JarEntry jarEntry = entries.nextElement();</span><br><span class="line">               <span class="comment">// no code</span></span><br><span class="line">               <span class="keyword">if</span> (jarEntry == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">continue</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">final</span> String namwenje = jarEntry.getName();</span><br><span class="line">               <span class="keyword">if</span> (name.startsWith(<span class="string">"META-INF/"</span>)) &#123;</span><br><span class="line">                   <span class="keyword">continue</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">//for faster, only check the meta.txt files</span></span><br><span class="line">               <span class="comment">//we will check other files's mad5 written in meta files</span></span><br><span class="line">               <span class="keyword">if</span> (!name.endsWith(ShareConstants.META_SUFFIX)) &#123;</span><br><span class="line">                   <span class="keyword">continue</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               metaContentMap.put(name, SharePatchFileUtil.loadDigestes(jarFile, jarEntry));</span><br><span class="line">               Certificate[] certs = jarEntry.getCertificates();</span><br><span class="line">               <span class="keyword">if</span> (certs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (!check(path, certs)) &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> TinkerRuntimeException(</span><br><span class="line">               String.format(<span class="string">"ShareSecurityCheck file %s, size %d verifyPatchMetaSignature fail"</span>, path.getAbsolutePath(), path.length()), e);</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (jarFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   jarFile.close();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">               Log.e(TAG, path.getAbsolutePath(), e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="tinkerId校验"><a href="#tinkerId校验" class="headerlink" title="tinkerId校验"></a>tinkerId校验</h4><p>baseApk的tinkerId是会声明在AndroidManifest.xml中，<br><img src="http://on8vjlgub.bkt.clouddn.com/tinker_id.png" alt="enter description here" title="tinker_id"><br>而patch.apk则是存在于/assets/package_meta.txt中<br><img src="http://on8vjlgub.bkt.clouddn.com/meta_tinker_id.png" alt="enter description here" title="meta_tinker_id"><br>此过程主要为了检查两个tinker_id是否一致<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//从mainifest或区域oldTinkerId</span><br><span class="line">      String oldTinkerId = getManifestTinkerID(context);</span><br><span class="line">      if (oldTinkerId == null) &#123;</span><br><span class="line">          return ShareConstants.ERROR_PACKAGE_CHECK_APK_TINKER_ID_NOT_FOUND;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      HashMap&lt;String, String&gt; properties = securityCheck.getPackagePropertiesIfPresent();</span><br><span class="line"></span><br><span class="line">      if (properties == null) &#123;</span><br><span class="line">          return ShareConstants.ERROR_PACKAGE_CHECK_PACKAGE_META_NOT_FOUND;</span><br><span class="line">      &#125;</span><br><span class="line">//获取patchTinkerId并进行对比</span><br><span class="line">      String patchTinkerId = properties.get(ShareConstants.TINKER_ID);</span><br><span class="line">      if (patchTinkerId == null) &#123;</span><br><span class="line">          return ShareConstants.ERROR_PACKAGE_CHECK_PATCH_TINKER_ID_NOT_FOUND;</span><br><span class="line">      &#125;</span><br><span class="line">      if (!oldTinkerId.equals(patchTinkerId)) &#123;</span><br><span class="line">          Log.e(TAG, &quot;tinkerId is not equal, base is &quot; + oldTinkerId + &quot;, but patch is &quot; + patchTinkerId);</span><br><span class="line">          return ShareConstants.ERROR_PACKAGE_CHECK_TINKER_ID_NOT_EQUAL;</span><br><span class="line">      &#125;</span><br><span class="line">      return ShareConstants.ERROR_PACKAGE_CHECK_OK;</span><br></pre></td></tr></table></figure></p>
<h4 id="tinkerFlag标记"><a href="#tinkerFlag标记" class="headerlink" title="tinkerFlag标记"></a>tinkerFlag标记</h4><p>根据不同的flag去开启或者关闭对应的功能<br>有如下一些标记<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//关闭tinker</span><br><span class="line">   public static final int TINKER_DISABLE             = 0x00;  </span><br><span class="line">   //开启dex</span><br><span class="line">   public static final int TINKER_DEX_MASK            = 0x01;</span><br><span class="line">   //开启nativeLarary</span><br><span class="line">   public static final int TINKER_NATIVE_LIBRARY_MASK = 0x02;</span><br><span class="line">   //开启resource</span><br><span class="line">   public static final int TINKER_RESOURCE_MASK       = 0x04;</span><br><span class="line">   //同时开启dex和resource</span><br><span class="line">   public static final int TINKER_DEX_AND_LIBRARY     = TINKER_DEX_MASK | TINKER_NATIVE_LIBRARY_MASK;</span><br><span class="line">   //开启所有功能</span><br><span class="line">   public static final int TINKER_ENABLE_ALL          = TINKER_DEX_MASK | TINKER_NATIVE_LIBRARY_MASK | TINKER_RESOURCE_MASK;</span><br></pre></td></tr></table></figure></p>
<p>进行功能设置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//check dex</span><br><span class="line">boolean dexEnable = isTinkerEnabledForDex(tinkerFlag);</span><br><span class="line">if (!dexEnable &amp;&amp; metaContentMap.containsKey(ShareConstants.DEX_META_FILE)) &#123;</span><br><span class="line">    return ShareConstants.ERROR_PACKAGE_CHECK_TINKERFLAG_NOT_SUPPORT;</span><br><span class="line">&#125;</span><br><span class="line">//check native library</span><br><span class="line">boolean nativeEnable = isTinkerEnabledForNativeLib(tinkerFlag);</span><br><span class="line">if (!nativeEnable &amp;&amp; metaContentMap.containsKey(ShareConstants.SO_META_FILE)) &#123;</span><br><span class="line">    return ShareConstants.ERROR_PACKAGE_CHECK_TINKERFLAG_NOT_SUPPORT;</span><br><span class="line">&#125;</span><br><span class="line">//check resource</span><br><span class="line">boolean resEnable = isTinkerEnabledForResource(tinkerFlag);</span><br><span class="line">if (!resEnable &amp;&amp; metaContentMap.containsKey(ShareConstants.RES_META_FILE)) &#123;</span><br><span class="line">    return ShareConstants.ERROR_PACKAGE_CHECK_TINKERFLAG_NOT_SUPPORT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="对比SharePatchInfo"><a href="#对比SharePatchInfo" class="headerlink" title="对比SharePatchInfo"></a>对比SharePatchInfo</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class SharePatchInfo &#123;</span><br><span class="line">	...</span><br><span class="line">    public String oldVersion;</span><br><span class="line">    public String newVersion;</span><br><span class="line">    public String fingerPrint;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>oldVersion是patch之前的版本，newVersion是指升级后的版本，<br>fingerPrint由下面这些参数提供:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private static String deriveFingerprint() &#123;</span><br><span class="line">    String finger = SystemProperties.get(&quot;ro.build.fingerprint&quot;);</span><br><span class="line">    if (TextUtils.isEmpty(finger)) &#123;</span><br><span class="line">        finger = getString(&quot;ro.product.brand&quot;) + &apos;/&apos; +</span><br><span class="line">                getString(&quot;ro.product.name&quot;) + &apos;/&apos; +</span><br><span class="line">                getString(&quot;ro.product.device&quot;) + &apos;:&apos; +</span><br><span class="line">                getString(&quot;ro.build.version.release&quot;) + &apos;/&apos; +</span><br><span class="line">                getString(&quot;ro.build.id&quot;) + &apos;/&apos; +</span><br><span class="line">                getString(&quot;ro.build.version.incremental&quot;) + &apos;:&apos; +</span><br><span class="line">                getString(&quot;ro.build.type&quot;) + &apos;/&apos; +</span><br><span class="line">                getString(&quot;ro.build.tags&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return finger;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="tryRecoverDexFiles"><a href="#tryRecoverDexFiles" class="headerlink" title="tryRecoverDexFiles"></a>tryRecoverDexFiles</h3><h3 id="tryRecoverLibraryFiles"><a href="#tryRecoverLibraryFiles" class="headerlink" title="tryRecoverLibraryFiles"></a>tryRecoverLibraryFiles</h3><h3 id="tryRecoverResourceFiles"><a href="#tryRecoverResourceFiles" class="headerlink" title="tryRecoverResourceFiles"></a>tryRecoverResourceFiles</h3><h2 id="六、检查odex文件"><a href="#六、检查odex文件" class="headerlink" title="六、检查odex文件"></a>六、检查odex文件</h2><p>waitDexOptFile<br>由于部分手机dex2oat过程是异步的，所以需要进行检测dex2oat是否确实生成，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> protected static boolean waitDexOptFile() &#123;</span><br><span class="line">        if (optFiles.isEmpty()) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int size = optFiles.size() * 6;</span><br><span class="line">        if (size &gt; MAX_WAIT_COUNT) &#123;</span><br><span class="line">            size = MAX_WAIT_COUNT;</span><br><span class="line">        &#125;</span><br><span class="line">        TinkerLog.i(TAG, &quot;dex count: %d, final wait time: %d&quot;, optFiles.size(), size);</span><br><span class="line"></span><br><span class="line">		//检查size的次数，每次检查休眠WAIT_ASYN_OAT_TIME时间，这里是8s。</span><br><span class="line">        for (int i = 0; i &lt; size; i++) &#123;</span><br><span class="line">            if (!checkAllDexOptFile(optFiles, i + 1)) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(WAIT_ASYN_OAT_TIME);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    TinkerLog.e(TAG, &quot;thread sleep InterruptedException e:&quot; + e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		//最后检查一次，如果还是没有找到，就return</span><br><span class="line">        for (File file : optFiles) &#123;</span><br><span class="line">            TinkerLog.i(TAG, &quot;check dex optimizer file %s, size %d&quot;, file.getName(), file.length());</span><br><span class="line"></span><br><span class="line">            if (!SharePatchFileUtil.isLegalFile(file)) &#123;</span><br><span class="line">                TinkerLog.e(TAG, &quot;final parallel dex optimizer file %s is not exist, return false&quot;, file.getName());</span><br><span class="line">                // don&apos;t report fail</span><br><span class="line">//                manager.getPatchReporter()</span><br><span class="line">//                    .onPatchDexOptFail(patchFile, file, file.getParentFile().getPath(),</span><br><span class="line">//                        file.getName(), new TinkerRuntimeException(&quot;dexOpt file:&quot; + file.getName() + &quot; is not exist&quot;));</span><br><span class="line">                return false;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="七、处理result"><a href="#七、处理result" class="headerlink" title="七、处理result"></a>七、处理result</h2><p>DefaultTinkerResultService处理相关逻辑,主要是onPatchResult()的回调，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public void onPatchResult(PatchResult result) &#123;</span><br><span class="line">    if(result == null) &#123;</span><br><span class="line">        TinkerLog.e(&quot;Tinker.DefaultTinkerResultService&quot;, &quot;DefaultTinkerResultService received null result!!!!&quot;, new Object[0]);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        TinkerLog.i(&quot;Tinker.DefaultTinkerResultService&quot;, &quot;DefaultTinkerResultService received a result:%s &quot;, new Object[]&#123;result.toString()&#125;);</span><br><span class="line">        TinkerServiceInternals.killTinkerPatchServiceProcess(this.getApplicationContext());</span><br><span class="line">        if(result.isSuccess) &#123;</span><br><span class="line">            this.deleteRawPatchFile(new File(result.rawPatchFilePath));</span><br><span class="line">            if(this.checkIfNeedKill(result)) &#123;</span><br><span class="line">                Process.killProcess(Process.myPid());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                TinkerLog.i(&quot;Tinker.DefaultTinkerResultService&quot;, &quot;I have already install the newly patch version!&quot;, new Object[0]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">st=>start: 开始
e=>end: 结束
op1=>operation: 接收patchFile
op2=>operation: 应用目录加载patch
op3=>operation: 写入header和map
op4=>operation: tryPatch操作
op5=>operation: 检查odex文件
op6=>operation: 处理结果result

st->op1->op2->op3->op4->op5->op6->e
``` 
类之间的关系图如下：
 ![enter description here][1]

## 一、准备知识
首先我们知道patch.apk是整个更新信息的载体，在加载补丁之前，我们需要弄清楚patch.apk的结构以及各个文件的作用。
### 1，patch.apk的主要结构
.
├── ./assets
│   ├── ./assets/dex_meta.txt	dex相关信息
│   ├── ./assets/only_use_to_test_tinker_resource.txt	测试文件
│   ├── ./assets/package_meta.txt	package相关信息
│   └── ./assets/res_meta.txt	resource变化信息
├── ./classes.dex   更新dex文件(非常规dex格式)
├── ./META-INF	 签名目录
│   ├── ./META-INF/ANDROIDD.RSA
│   ├── ./META-INF/ANDROIDD.SF
│   └── ./META-INF/MANIFEST.MF
├── ./res		变化的res目录
│   ├── ./res/layout
│   │   └── ./res/layout/activity_main.xml
│   └── ./res/layout-v17
│       └── ./res/layout-v17/activity_main.xml
└── ./test.dex	测试dex文件
### 2，package_meta.txt
下面是一个测试的package_meta的例子
```txt
#base package config field
#Thu Mar 16 11:29:04 CST 2017
platform=all
NEW_TINKER_ID=tinker_id_9d2b250
TINKER_ID=tinker_id_9d2b250
patchMessage=tinker is sample to use
patchVersion=1.0</textarea><textarea id="flowchart-0-options" style="display: none">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/补丁/" rel="tag"># 补丁</a>
          
            <a href="/tags/热更新/" rel="tag"># 热更新</a>
          
            <a href="/tags/源码分析/" rel="tag"># 源码分析</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/03/15/热更新Tinker研究（二）：结合源码学习Dex格式/" rel="next" title="热更新Tinker研究（二）：结合源码学习Dex格式">
                <i class="fa fa-chevron-left"></i> 热更新Tinker研究（二）：结合源码学习Dex格式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/20/热更新Tinker研究（四）：TinkerLoader/" rel="prev" title="热更新Tinker研究（四）：TinkerLoader">
                热更新Tinker研究（四）：TinkerLoader <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  
    <div class="comments" id="comments">
      <div id="vcomments"></div>
    </div>
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://on8vjlgub.bkt.clouddn.com/9s.png"
                alt="WellerV" />
            
              <p class="site-author-name" itemprop="name">WellerV</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/WellerV" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:huweigoodboy@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://blog.csdn.net/huweigoodboy" target="_blank" title="CSDN">
                    
                      <i class="fa fa-fw fa-csdn"></i>CSDN</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#3，dex-meta-txt"><span class="nav-number">1.</span> <span class="nav-text">3，dex_meta.txt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4，res-meta-txt"><span class="nav-number">2.</span> <span class="nav-text">4，res_meta.txt</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、日志分析jieguo"><span class="nav-number"></span> <span class="nav-text">二、日志分析jieguo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#接收Patch-File"><span class="nav-number">1.</span> <span class="nav-text">接收Patch File</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用目录加载patch"><span class="nav-number">2.</span> <span class="nav-text">应用目录加载patch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tryPatch"><span class="nav-number">3.</span> <span class="nav-text">tryPatch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查odex文件"><span class="nav-number">4.</span> <span class="nav-text">检查odex文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理Result"><span class="nav-number">5.</span> <span class="nav-text">处理Result</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、接收PatchFile"><span class="nav-number"></span> <span class="nav-text">三、接收PatchFile</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#patchCheck"><span class="nav-number">1.</span> <span class="nav-text">patchCheck</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动TinkerPatchService"><span class="nav-number">2.</span> <span class="nav-text">启动TinkerPatchService</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、应用目录加载patch"><span class="nav-number"></span> <span class="nav-text">四、应用目录加载patch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、tryPatch"><span class="nav-number"></span> <span class="nav-text">五、tryPatch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#校验"><span class="nav-number">1.</span> <span class="nav-text">校验</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#文件合法性校验"><span class="nav-number">1.1.</span> <span class="nav-text">文件合法性校验</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#signature校验"><span class="nav-number">1.2.</span> <span class="nav-text">signature校验</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tinkerId校验"><span class="nav-number">1.3.</span> <span class="nav-text">tinkerId校验</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tinkerFlag标记"><span class="nav-number">1.4.</span> <span class="nav-text">tinkerFlag标记</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对比SharePatchInfo"><span class="nav-number">2.</span> <span class="nav-text">对比SharePatchInfo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tryRecoverDexFiles"><span class="nav-number">3.</span> <span class="nav-text">tryRecoverDexFiles</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tryRecoverLibraryFiles"><span class="nav-number">4.</span> <span class="nav-text">tryRecoverLibraryFiles</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tryRecoverResourceFiles"><span class="nav-number">5.</span> <span class="nav-text">tryRecoverResourceFiles</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六、检查odex文件"><span class="nav-number"></span> <span class="nav-text">六、检查odex文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#七、处理result"><span class="nav-number"></span> <span class="nav-text">七、处理result</span></a></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WellerV</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  






  
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine@1.1.4/dist/Valine.min.js"></script>
  <script type="text/javascript">
    new Valine({
        av: AV,
        el: '#vcomments' ,
        verify: false,
        notify: true,
        app_id: 'TBXtwLEKkNbKob0jsxIgU1rz-gzGzoHsz',
        app_key: 'An9P3QVa6PpajmFLtxCtfS1h',
        placeholder: '今天你要元气满满の评论哦！'
    });
  </script>



  





  

  

  

  

  

  

</body>
</html>
